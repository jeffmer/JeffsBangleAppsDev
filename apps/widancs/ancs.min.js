(function(){function u(){a.ancs={primary:null,notify:null,control:null,data:null};a.gatt.getPrimaryService("7905F431-B5CE-4E99-A40F-4B1E122D00D0").then(function(b){a.ancs.primary=b;return b.getCharacteristic("9FBF120D-6301-42D9-8C58-25E699A21DBD")}).then(function(b){a.ancs.notify=b;return a.ancs.primary.getCharacteristic("69D1D8F3-45E1-49A8-9821-9BBDFDAAD9D9")}).then(function(b){a.ancs.control=b;return a.ancs.primary.getCharacteristic("22EAC6E9-24D6-4BB5-BE44-B36ACE7C7BFB")}).then(function(b){a.ancs.data=
    b;f(3);a.ancs.notify.on("characteristicvaluechanged",function(b){var c=b.target.value,d=c.getUint8(0);b=c.getUint8(2);c=c.getUint32(4,!0);1<d||(m&&clearTimeout(m),v.includes(b)&&(d=a.notqueue.length,1==b?(k&&(a.notqueue.push(a.current),k=!1),a.notqueue.push({cat:b,uid:c})):16>d&&(a.notqueue[d]={cat:b,uid:c}),m=setTimeout(n,1E3)))});a.ancs.data.on("characteristicvaluechanged",function(b){a.store(b.target.value.buffer);(b=a.gotmsg())&&w(a.buf,b)});a.ancs.notify.startNotifications().then(function(){a.ancs.data.startNotifications().then(function(){f(4)})})})["catch"](function(b){Terminal.println("ERROR "+
    b)})}function x(b){b=b.split("\n");for(var a=0;a<b.length;a++){b[a]=b[a].trim();var e=b[a];if(18<e.length){for(var d=18;10<d&&!" \t-_".includes(e[d]);)d--;10==d&&(d=18);b[a]=e.substr(0,d);b.splice(a+1,0,e.substr(d))}}return b.join("\n")}function y(){l=setTimeout(function(){SCREENACCESS.release();l=void 0;k=!1;n()},500)}function w(b,c){function e(b){var c=new Uint8Array(6),d=DataView(c.buffer);d.setUint8(0,2);d.setUint32(1,a.current.uid,!0);d.setUint8(5,b?0:1);a.ancs.control.writeValue(c).then(y)}
    a.msgTO&&clearTimeout(a.msgTO);for(var d="",h=8;h<8+c.tlen;++h)d+=String.fromCharCode(b[h]);h="";for(var f=11+c.tlen;f<11+c.tlen+c.mlen;++f)h+=String.fromCharCode(b[f]);h=x(h);E.showPrompt();l&&clearTimeout(l);Bangle.setLCDPower(!0);SCREENACCESS.request();p||(p=!0,Bangle.buzz(500).then(function(){p=!1}));1!=a.current.cat?E.showAlert(h,d).then(e.bind(null,!1)):E.showPrompt(h,{title:d,buttons:{Accept:!0,Cancel:!1}}).then(e)}function n(){if(0!=a.notqueue.length&&!k){k=!0;a.current=a.notqueue.pop();var b=
    DataView(a.com.buffer);6==a.current.cat?b.setUint8(8,2):b.setUint8(8,3);b.setUint32(1,a.current.uid,!0);a.inp=0;a.ancs.control.writeValue(a.com).then(function(){a.msgTO=setTimeout(function(){k=!1;a.msgTO=void 0;n()},1E3)})}}function f(a){q=a;WIDGETS.ancs.draw()}var r=require("Storage").readJSON("widancs.json",1)||{settings:{enabled:!1,category:[1,2,4]}},t=r.settings.enabled,v=r.settings.category,a={gatt:null,ancs:null,current:{cat:0,uid:0},notqueue:[],msgTO:void 0,com:new Uint8Array([0,0,0,0,0,1,
    20,0,3,100,0]),buf:new Uint8Array(132),inp:0,store:function(a){var b=this.inp;132>=b+a.length&&(this.buf.set(a,b),this.inp+=a.length)},gotmsg:function(){var a=this.inp,c=DataView(this.buf.buffer);if(8>a)return null;var e=c.getUint16(6,!0);if(a<e+8)return null;c=c.getUint16(9+e,!0);return a<c+e+11?null:{tlen:e,mlen:c}}};if(t&&"undefined"!=typeof SCREENACCESS)NRF.on("connect",function(b){a.gatt=NRF.getGattforCentralServer(b);f(1);a.gatt.device.on("gattserverdisconnected",function(b){f(0);delete a.gatt;
    delete a.ancs;NRF.wake()});E.on("kill",function(){a.gatt.disconnect().then(function(){NRF.sleep()})});NRF.setSecurity({passkey:"123456",mitm:1,display:1});var c,e=setTimeout(function(){c&&clearInterval(c);a.gatt.disconnect().then(function(){f(0);delete a.gatt;delete a.ancs;NRF.wake()})},3E3);a.gatt.startBonding().then(function(){c=setInterval(function(){var b=a.gatt.getSecurityStatus();b.connected?b.connected&&b.encrypted&&(clearInterval(c),clearTimeout(e),f(2),u()):(clearInterval(c),clearTimeout(e))},
    1E3)})["catch"](function(a){Terminal.println("ERROR "+a)})});var p=!1,l=void 0,k=!1,m,q=5;WIDGETS.ancs={area:"tl",width:24,draw:function(){var a=new Uint16Array([50712,63512,1023,65504,2016,0]),c=E.toArrayBuffer(atob("GBgBAAAABAAADgAAHwAAPwAAf4AAP4AAP4AAP4AAHwAAH4AAD8AAB+AAA/AAAfgAAf3gAH/4AD/8AB/+AA/8AAf4AAHwAAAgAAAA"));g.setColor(a[q]);g.drawImage(c,this.x,this.y)}};t&&"undefined"!=typeof SCREENACCESS&&(q=0,NRF.setServices(void 0,{uart:!1}),NRF.sleep(),NRF.wake(),NRF.setAdvertising([2,1,6,17,21,
    208,0,45,18,30,75,15,164,153,78,206,181,49,244,5,121],{connectable:!0,discoverable:!0,interval:375}))})();
    