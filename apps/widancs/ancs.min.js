(function(){function t(){a.ancs={primary:null,notify:null,control:null,data:null};a.gatt.getPrimaryService("7905F431-B5CE-4E99-A40F-4B1E122D00D0").then(function(b){a.ancs.primary=b;return b.getCharacteristic("9FBF120D-6301-42D9-8C58-25E699A21DBD")}).then(function(b){a.ancs.notify=b;return a.ancs.primary.getCharacteristic("69D1D8F3-45E1-49A8-9821-9BBDFDAAD9D9")}).then(function(b){a.ancs.control=b;return a.ancs.primary.getCharacteristic("22EAC6E9-24D6-4BB5-BE44-B36ACE7C7BFB")}).then(function(b){a.ancs.data=
b;k(3);a.ancs.notify.on("characteristicvaluechanged",function(b){var c=b.target.value,e=c.getUint8(0);b=c.getUint8(2);c=c.getUint32(4,!0);0==e&&u.includes(b)&&(e=a.notqueue.length,1==b?(f&&(a.notqueue.push(a.current),f=!1),a.notqueue.push({cat:b,uid:c})):8>e&&(a.notqueue[e]={cat:b,uid:c}),m())});a.ancs.data.on("characteristicvaluechanged",function(b){a.store(b.target.value.buffer);(b=a.gotmsg())&&v(a.buf,b)});a.ancs.notify.startNotifications().then(function(){a.ancs.data.startNotifications().then(function(){k(4)})})}).catch(function(b){Terminal.println("ERROR "+
b)})}function w(b){b=b.split("\n");for(var a=0;a<b.length;a++){b[a]=b[a].trim();var d=b[a];if(18<d.length){for(var e=18;10<e&&!" \t-_".includes(d[e]);)e--;10==e&&(e=18);b[a]=d.substr(0,e);b.splice(a+1,0,d.substr(e))}}return b.join("\n")}function x(){l=setTimeout(function(){SCREENACCESS.release();l=void 0;f=!1;m()},500)}function v(b,c){function d(b){var c=new Uint8Array(6),d=DataView(c.buffer);d.setUint8(0,2);d.setUint32(1,a.current.uid,!0);d.setUint8(5,b?0:1);a.ancs.control.writeValue(c).then(x)}
a.msgTO&&clearTimeout(a.msgTO);for(var e="",h=8;h<8+c.tlen;++h)e+=String.fromCharCode(b[h]);h="";for(var f=11+c.tlen;f<11+c.tlen+c.mlen;++f)h+=String.fromCharCode(b[f]);h=w(h);E.showPrompt();l&&clearTimeout(l);Bangle.setLCDPower(!0);SCREENACCESS.request();n||(n=!0,Bangle.buzz(500).then(function(){n=!1}));1!=a.current.cat?E.showAlert(h,e).then(d.bind(null,!1)):E.showPrompt(h,{title:e,buttons:{Accept:!0,Cancel:!1}}).then(d)}function m(){if(0!=a.notqueue.length&&!f){f=!0;a.current=a.notqueue.pop();var b=
DataView(a.com.buffer);6==a.current.cat?b.setUint8(8,2):b.setUint8(8,3);b.setUint32(1,a.current.uid,!0);a.inp=0;a.ancs.control.writeValue(a.com).then(function(){a.msgTO=setTimeout(function(){f=!1;a.msgTO=void 0;m()},1E3)})}}function k(b){p=b;WIDGETS.ancs.draw()}var q=require("Storage").readJSON("widancs.json",1)||{settings:{enabled:!1,category:[1,2,4]}},r=q.settings.enabled,u=q.settings.category,a={gatt:null,ancs:null,current:{cat:0,uid:0},notqueue:[],msgTO:void 0,com:new Uint8Array([0,0,0,0,0,1,
20,0,3,100,0]),buf:new Uint8Array(132),inp:0,store:function(b){var a=this.inp;132>=a+b.length&&(this.buf.set(b,a),this.inp+=b.length)},gotmsg:function(){var a=this.inp,c=DataView(this.buf.buffer);if(8>a)return null;var d=c.getUint16(6,!0);if(a<d+8)return null;c=c.getUint16(9+d,!0);return a<c+d+11?null:{tlen:d,mlen:c}}};if(r&&"undefined"!=typeof SCREENACCESS)NRF.on("connect",function(b){a.gatt=NRF.getGattforCentralServer(b);k(1);a.gatt.device.on("gattserverdisconnected",function(b){k(0);delete a.gatt;
delete a.ancs;NRF.wake()});E.on("kill",function(){a.gatt.disconnect().then(function(){NRF.sleep()})});NRF.setSecurity({passkey:"123456",mitm:1,display:1});a.gatt.startBonding().then(function(){var b=setInterval(function(){var c=a.gatt.getSecurityStatus();c.connected?c.connected&&c.encrypted&&(clearInterval(b),k(2),t()):clearInterval(b)},2E3)}).catch(function(a){Terminal.println("ERROR "+a)})});var n=!1,l=void 0,f=!1,p=5;WIDGETS.ancs={area:"tl",width:24,draw:function(){var a=new Uint16Array([50712,
63488,1023,65504,2016,0]),c=E.toArrayBuffer(atob("GBgBAAAABAAADgAAHwAAPwAAf4AAP4AAP4AAP4AAHwAAH4AAD8AAB+AAA/AAAfgAAf3gAH/4AD/8AB/+AA/8AAf4AAHwAAAgAAAA"));g.setColor(a[p]);g.drawImage(c,this.x,this.y)}};r&&"undefined"!=typeof SCREENACCESS&&(p=0,NRF.setServices(void 0,{uart:!1}),NRF.sleep(),NRF.wake(),NRF.setAdvertising([2,1,6,17,21,208,0,45,18,30,75,15,164,153,78,206,181,49,244,5,121],{connectable:!0,discoverable:!0,interval:375}))})();
