<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>

    <h4>List of waypoints</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Lat.</th>
          <th>Long.</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="waypoints">
        
      </tbody>
    </table>
    <br><br>
    <h4>Add a new waypoint</h4>
    <form id="add_waypoint_form">
      <div class="columns">
        <div class="column col-4 col-xs-12">
          <input class="form-input input-sm" type="text" id="add_waypoint_name" placeholder="Name">
        </div>
        <div class="column col-4 col-xs-12">
          <input class="form-input input-sm" value="0.0000" type="number" step="0.0001" id="add_latitude" placeholder="Lat">
        </div>
        <div class="column col-4 col-xs-12">
            <input class="form-input input-sm" value="0.0000" type="number" step="0.0001" id="add_longtitude" placeholder="Long">
          </div>
        <div class="column col-4 col-xs-12">
          <button id="add_waypoint_button" class="btn btn-primary btn-sm">Add</button>
        </div>
      </div>
    </form>
    <br><br>
    <button id="reset" class="btn btn-error">Reset</button> <button id="upload" class="btn btn-primary">Upload</button>
    
    <script src="../../lib/interface.js"></script>

    <script>

      var waypoints = []
     // try{
     //   var stored = localStorage.getItem('waypoint_list')
     //   if(stored) waypoints = JSON.parse(stored);
     // }catch(e){}

      var $name = document.getElementById('add_waypoint_name')
      var $form = document.getElementById('add_waypoint_form')
      var $button = document.getElementById('add_waypoint_button')
      var $latitude = document.getElementById('add_latitude')
      var $longtitude = document.getElementById('add_longtitude')
      var $list = document.getElementById('waypoints')
      var $reset = document.getElementById('reset')

      //renderWaypoints()
      
      $reset.addEventListener('click', reset)

      $form.addEventListener('submit', event => {
        event.preventDefault()
        
        var name = $name.value.trim()
        if(!name) return;
        var lat = parseFloat($latitude.value)
        var lon = parseFloat($longtitude.value)

        waypoints.push({
          mark: 1,
          name, lat,lon,
        })

        renderWaypoints()
        $name.value = ''
        $latitude.value = 0.0000
        $longtitude.value = 0.0000
        save()
      })

      function save(){
        localStorage.setItem('waypoint_list',JSON.stringify(waypoints));
      }

      function reset(){
        waypoints = []
        save()
        renderWaypoints()
      }

      function removeWaypoint(index){
        waypoints = waypoints.filter((p,i) => i!==index)
        save()
        renderWaypoints()
      }

      function renderWaypoints(){
        $list.innerHTML = ''
        waypoints.forEach((waypoint,index) => {
          var $waypoint = document.createElement('tr')
          
          $waypoint.innerHTML = `<td>${waypoint.name}</td><td>${waypoint.lat}</td><td>${waypoint.lon}</td><td><button class="btn btn-error" onclick="removeWaypoint(${index})">remove</button></td>`
          $list.appendChild($waypoint)
        })
        $name.focus()    
      }

      function downloadJSONfile(fileid, callback) {
        Puck.write(`\x10(function() {
          var f = require("Storage").open("${fileid}","r");
          var l = f.readLine();
          while (l!==undefined) { Bluetooth.print(l); l = f.readLine(); }
         })()\n`,contents=>{
              var storedpts = JSON.parse(contents);
              callback(storedpts);
        });
      }

      function gotStored(pts){
          waypoints = pts;
          renderWaypoints();
      }

      function onInit() {
         downloadJSONfile("waypoints.json", gotStored);
      }

      document.getElementById("upload").addEventListener("click", function() {
        var data =  JSON.stringify(waypoints);
   //       sendCustomizedApp({
   //       storage:[
   //         {name:"test.json",content:data,evaluate:false}
   //       ]
   //     });
      });
    </script>
  </body>
</html>